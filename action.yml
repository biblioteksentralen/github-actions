name: Setup dependencies
description: Setup depdendencies for Libry-Content

inputs:
  installDependencies:
    description: 'Install dependencies'
    required: false
    default: 'true'
  nodeVersion:
    description: 'NodeJS version'
    required: false
    default: '14'
  npmVersion:
    description: 'NPM version'
    required: false
    default: '7'
  cacheName:
    description: 'Cache name'
    required: false
    default: 'cache-node-modules-v3'
outputs:
  pullRequest:
    description: "Associated GitHub Pull Request as a JSON string"
    value: ${{ steps.pr.outputs.pr }}
  pullRequestNumber:
    description: "Numerical identifier of associated GitHub Pull Request"
    value: ${{ steps.pr.outputs.number }}
runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v2
    - if: inputs.installDependencies == 'true'
      uses: actions/setup-node@v2
      with:
        node-version: ${{ inputs.nodeVersion }}
    - if: inputs.installDependencies == 'true'
      run: npm install -g npm@${{ inputs.npmVersion }}
      shell: bash
    - if: inputs.installDependencies == 'true'
      id: cache-node-modules
      uses: actions/cache@v2
      env:
        cache-name: cache-node-modules-v3
      with:
        path: |
          ~/node_modules
          ~/**/node_modules
        key: ${{ runner.os }}-build-${{ inputs.cacheName }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ inputs.cacheName }}-
    - if: inputs.installDependencies == 'true' && steps.cache-node-modules.outputs.cache-hit != 'true'
      run: npm ci && npm run postinstall
      shell: bash
    - uses: rlespinasse/github-slug-action@4.0.0
    - run: |
        echo "E2E_DATASET=$(echo "e2e-${{ env.GITHUB_REF_SLUG }}" | head -c 20)" >> $GITHUB_ENV
        echo "PREVIEW_DEPLOYMENT_URL=${{ env.GITHUB_REF_SLUG }}.qa.bibliotek-test.io" >> $GITHUB_ENV
      shell: bash
    - name: Get PR associated with branch
      uses: 8BitJonny/gh-get-current-pr@1.3.0
      id: pr
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        sha: ${{ github.event.pull_request.head.sha }}
        filterOutClosed: true
    - name: Export Pull Request number and Jira Issue as environment variables
      run: |
        echo "JIRA_ISSUE=$(echo "${{ steps.pr.outputs.prTitle }}" | grep -e '[A-Z]\+-[0-9]\+' -o)" >> $GITHUB_ENV
        echo "PR_NUMBER=$(echo "${{ steps.pr.outputs.number }}")" >> $GITHUB_ENV
      shell: bash

