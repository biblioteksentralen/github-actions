name: Setup dependencies
description: Setup depdendencies for Libry-Content

inputs:
  nodeVersion:
    description: 'NodeJS version'
    required: false
    default: '14'
  npmVersion:
    description: 'NPM version'
    required: false
    default: '7'
  cacheName:
    description: 'Cache name'
    required: false
    default: 'cache-node-modules-v3'

runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v2
    - name: Setup Node.js ${{ inputs.nodeVersion }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ inputs.nodeVersion }}
    - name: Upgrade to NPM v${{ inputs.npmVersion }}
      run: npm install -g npm@${{ inputs.npmVersion }}
      shell: bash
    - name: Cache node modules
      id: cache-node-modules
      uses: actions/cache@v2
      env:
        cache-name: cache-node-modules-v3
      with:
        path: |
          ~/node_modules
          ~/**/node_modules
        key: ${{ runner.os }}-build-${{ inputs.cacheName }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ inputs.cacheName }}-
    - name: Install dependencies if cache miss
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: npm ci && npm run postinstall
      shell: bash
    - uses: rlespinasse/github-slug-action@4.0.0
    - run: |
        echo "E2E_DATASET=$(echo "e2e-${{ env.GITHUB_REF_SLUG }}" | head -c 20)" >> $GITHUB_ENV
        echo "PREVIEW_DEPLOYMENT_URL=${{ env.GITHUB_REF_SLUG }}.qa.bibliotek-test.io" >> $GITHUB_ENV
      shell: bash
